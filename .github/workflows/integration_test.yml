name: Brieflow Integration Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Mamba
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-variant: Mambaforge
          environment-file: brieflow_main_env.yml
          use-mamba: true
          auto-activate-base: false

      - name: Run small test setup
        shell: bash -l {0}
        run: python tests/small_test_analysis_setup.py

      - name: Run Snakemake pipeline
        shell: bash -l {0}
        working-directory: tests/small_test_analysis
        run: |
          snakemake \
            --cores all \
            --use-conda \
            --snakefile "../../workflow/Snakefile" \
            --configfile "config/config.yml" \
            --rerun-triggers mtime \
            --until all_phenotype

      - name: Run pytest
        shell: bash -l {0}
        run: pytest tests/

snakemake --use-conda --cores all \
    --snakefile "../../workflow/Snakefile" \
    --configfile "config/config.yml" \
    --rerun-triggers mtime \
    --until all_phenotype