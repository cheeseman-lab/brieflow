# 5. Development

## Overview

Brieflow is meant to be very adaptable for new screening contexts.
As OPS develops, we expect users to make changes for their specific context.
Pieces of these changes that are useful for the broad OPS community may be included in the `main` branch of brieflow.

```{image} media/development.png
:align: center
:alt: Development
```

The general process of screen adaptation is as follows:

1) Make a new fork/branch for a new screening context.
Adapt Brieflow for this screening context.
2) If there is code that would be useful to the `main` branch, make a PR to contribute this code.
See the *Contributing* section below for more info.

[Matteo](https://github.com/mat10d) and [Roshan](https://github.com/roshankern) will be responsible for `main` brieflow development. 
These responsibilities include:

- Determining standards for OPS screening (where applicable)
- Updating documentation
- Helping users with issues
- Reviewing PRs to incorporate branches into the `main` branch

## Screen Adaptation

Users should do the following as they adapt Brieflow to their own screen:

1) Make a user-specific [fork](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/fork-a-repo) of brieflow.
2) Make a screening context-specific [branch](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-and-deleting-branches-within-your-repository) with the screening context code changes.
Make sure to self-review the PR to ensure the additional code is only what is useful for the main branch.

### Development Conventions

When developing new computational methodologies for Brieflow, follow these conventions:

#### Code Organization
- Module: Large changes to an existing module or extending Brieflow functionality
    - Changes to module env, rules, scripts, targets, functions
    - Ex: Adding a “Pipeline Evaluation” module to the end of Brieflow to compute metrics for an entire run
- Process: Large change to an existing process script or adding a process script
    - Changes to process script, functions and possible changes to module env, rules, targets
    - Ex: Adding a script for a new type of illumination correction that can be used interchangeably with old script
- Function: Small changes to existing function
    - Changes to function code in Brieflow library
    - Ex: adding an option to `extract_nd2_metadata` to extract an additional piece of metadata

When editing a process (ex to change how a script functions):
1) modify a function in lib
2) make any equivalent changes in the script 
3) edit rules to change parameters of process 

If editing a module (ex to add a new rule):
1) make process changes above
2) change targets to reflect outputs

If adding a new module:
1) make process/module changes above
2) change main Snakefile to reflect modules

## Contributing

Brieflow is still actively under development and we welcome community use and development.

### How to Contribute

We aim to strike a balance between simplicity and functionality in the `main` branch.
For this reason, we will only incorporate code into main that is helpful for a general/standardized OPS screening context.
If you have code that would help other brieflow users, please make a [pull request](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork) to `main`.
Matteo and Roshan will review this pull request and guide it to be merged!

To contribute:
- File a [GitHub issue](https://github.com/cheeseman-lab/brieflow/issues) to share comments and issues
- File a GitHub PR to contribute to Brieflow as detailed in the pull request template (`.github/pull_request_template.md`)
- Read about how to [contribute to a project](https://docs.github.com/en/get-started/exploring-projects-on-github/contributing-to-a-project) to understand forks, branches, and PRs

### Development Tools

We use [ruff](https://github.com/astral-sh/ruff) for linting and formatting code.
Ruff is automatically installed within each Brieflow environment.
We recommend using `ruff check .` and `ruff format --check` from an active Brieflow environment to lint and format code as you develop.

### Coding Conventions

When contributing code, please follow these conventions:

#### Documentation and Formatting
- Use [one sentence per line](https://nick.groenen.me/notes/one-sentence-per-line/) convention for markdown files
- Use [Google format](https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings) for function docstrings

#### File Formats
- Use [tsv](https://en.wikipedia.org/wiki/Tab-separated_values#:~:text=Tab%2Dseparated%20values%20(TSV),similar%20to%20comma%2Dseparated%20values.) file format for saving small dataframes that require easy readability
- Use [parquet](https://www.databricks.com/glossary/what-is-parquet) file format for saving large dataframes

#### Naming Conventions
- Data files: Data location information (well, tile, cycle, etc) + `__` + type of information (cell features, phenotype info, etc) + `.` + file type
- Data is stored in its respective analysis directories
- Example: `brieflow_output/preprocess/metadata/phenotype/P-1_W-A2_T-571__metadata.tsv`

#### Versioning
- We use [semantic versioning](https://semver.org/) for brieflow and brieflow-analysis versions
- These two repositories should always have the same version
- Small version changes are only tracked in the `pyproject.toml` file of brieflow (not in brieflow-analysis)

### Integration Tests

To ensure new features don't break Brieflow, we have integration tests set up to automatically Brieflow on test data when a PR to main is created.

The integration test simply runs the `Test Installation` code from [2. Installation & Analysis Setup](https://brieflow.readthedocs.io/en/latest/2.installation_analysis_setup.html) (step 3) in a Github action.

We recommend running the test analysis locally when planning to integrate features to ensure the new code can integrate into Brieflow successfully.
Depending on the contribution, it may be necessary to update the test analysis config files at `brieflow/tests/small_test_analysis/config`.